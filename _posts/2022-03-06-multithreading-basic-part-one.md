---
layout: post
title: "Многопоточность основы 1"
date:   2022-03-06
last_modified_at: 2022-03-07
categories: [programming]
---

Этот пост сделан основываясь на книге Джефри Рихтера "CLR via C#".

Изначально в Windows был один поток исполнения. От этого подхода отказались, так как в случае попадания в бесконечный цикл приходилось перезагружать компьютер и терять данные.

Следующим этапом развития этой операционной системы стало решение запускать каждый экземпляр приложения в отдельном процессе.

// Определение, выделить
Процесс - набор ресурсов, используемый отдельным экземпляром приложения.

Каждому процессу выделяется виртуальное адресное пространство. Это гарантирует что код и данные одного процесса будут недоступны для другого.

Процессы не решали проблему бесконечного цикла. Для её решения и были придуманы потоки. Поток // выделить курсивом // стал концепцией предназначеной для виртуализации процессора в Windows.

Каждый поток состоит из нескольких частей:
1. Объект ядра потока (thread kernel object) - набор свойств этой структуры описывает поток. Также структура содержит контекст потока, блок памяти с набором регистров процессора.
2. Блок обнаружения потока (Thread Environment Block, TEB) - адресное пространство к которому имеет быстрый доступ код приложений. Содержит заголовок цепочки исключений. Каждый блок try, в который входит поток вставляет свой узел в начало цепочки. После выхода из блока try, узел из цепочки удаляется. Содержит локальное хранилище данных используемое GDI и OpenGL.
3. Стек пользовательского режима (user-mode stack). Применяется для хранения передаваемых в методы локальных переменных и аргументов. Также он содержит адрес, показывающий, откуда начнет исполнение поток после того как текущий метод возвратит управление.
4. Стек режима ядра (kernel-mode stack) Используется когда код приложения передает агрументы в функцию операционной системы, находящуюся в режиме ядра. Аргументы копируются и проверяются. Используется для безопастности. Так же используется в случае когда ядро вызывает свои методы.
5. Уведомления о создании и завершении потоков. Если в Windows создается поток, то для всех загруженных в этот процесс DLL-библиотек вызывается метод DllMain с флагом DLL_THREAD_ATTACH, при завершении DLL_THREAD_DETACH. Некоторые библиотеки выполняют специальные операции инициализации или очистки для каждого созданного/завершенного в процессе потока.

Создание, поддержка и завершение ресурсов требует затрат времени и памяти. Так же мы теряем время из-за переключения контекста (context switching) - распределения нескольких логических процессоров на физическом процессоре.
